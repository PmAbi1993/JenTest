name: Duuude

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}â€‘${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: macos-14
    steps:
    - uses: actions/checkout@v4

    - uses: maxim-lobanov/setup-xcode@v1
      with: { xcode-version: '16.2' }

    # ðŸ”‘ NEW â€” make sure an iOS runtime exists
    - name: Install iOS simulator runtime if missing
      run: |
        set -eo pipefail
        if ! xcrun simctl list runtimes | grep -q "iOS"; then
          echo "::group::Downloading iOS runtime"
          sudo xcodebuild -license accept          # nonâ€‘interactive
          sudo xcodebuild -downloadPlatform iOS    # grabs the newest runtime
          sudo xcodebuild -runFirstLaunch          # registers it with CoreSimulator
          echo "::endgroup::"
        fi

    - id: sim
      uses: futureware-tech/simulator-action@v4
      with:
        model: 'iPhone 15'
        wait_for_boot: true
        erase_before_boot: true

    - name: Build & test
      env:
        DESTINATION_UDID: ${{ steps.sim.outputs.udid }}
      run: |
        set -o pipefail
        xcodebuild test \
          -scheme JenTest \
          -destination "id=$DESTINATION_UDID" \
          | xcpretty --test --color