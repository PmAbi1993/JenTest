name: BuildÂ andÂ Test   # â€” a universal iOS CI workflow

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: macos-14            # macOSâ€‘latest â‰ƒ macOSâ€‘15 today, but keep this explicit
    timeout-minutes: 60

    env:
      SCHEME: JenTest            # <â€”â€” replace with your scheme name
      DEVICE_MODEL: 'iPhone 15'  # <â€”â€” or any model listed in the simulatorâ€‘action wiki

    steps:
    # 1ï¸âƒ£Â Check out code --------------------------------------------------------
    - uses: actions/checkout@v4

    # 2ï¸âƒ£Â Select Xcode ----------------------------------------------------------
    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'    # roll back to 16.1 if you donâ€™t need the 18.2 SDK

    # 3ï¸âƒ£Â Guarantee an iOS runtime exists --------------------------------------
    - name: Ensure iOS simulator runtime is present
      run: |
        set -euo pipefail
        if xcrun simctl list runtimes | grep -q "iOS"; then
          echo "âœ… iOS runtime already installed"
          exit 0
        fi

        echo "ğŸ”§ No iOS runtime â€“ downloading â€¦"
        sudo xcodebuild -license accept >/dev/null        # nonâ€‘interactive
        sudo xcodebuild -downloadPlatform iOS             # grabs latest runtime
        sudo xcodebuild -runFirstLaunch                   # registers it

        xcrun simctl list runtimes | grep iOS || \
          { echo "âŒ Runtime still missing after download"; exit 1; }

    # 4ï¸âƒ£Â Boot a clean simulator & get its UDID --------------------------------
    - id: sim
      uses: futureware-tech/simulator-action@v4
      with:
        model: ${{ env.DEVICE_MODEL }}
        wait_for_boot: true
        erase_before_boot: true  # avoids state bleed between jobs

    # 5ï¸âƒ£Â Build & test ----------------------------------------------------------
    - name: Build and run tests
      run: |
        set -o pipefail
        xcodebuild test \
          -scheme "$SCHEME" \
          -destination "id=${{ steps.sim.outputs.udid }}" \
          | xcpretty --test --color

    # 6ï¸âƒ£Â Extra diagnostics on failure -----------------------------------------
    - name: List devices & runtimes (debug only)
      if: failure()
      run: |
        xcrun simctl list devices
        xcrun simctl list runtimes